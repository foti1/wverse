<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>WeedVerse® POC</title>
    
    <script src="https://aframe.io/releases/1.6.0/aframe.min.js"></script>
    <script src="https://unpkg.com/aframe-orbit-controls@1.3.0/dist/aframe-orbit-controls.min.js"></script>

    <script>
      if (typeof THREE !== 'undefined') {
        if (!THREE.Quaternion.prototype.inverse) {
          THREE.Quaternion.prototype.inverse = THREE.Quaternion.prototype.invert;
        }
        if (!THREE.Matrix4.prototype.inverse) {
          THREE.Matrix4.prototype.inverse = THREE.Matrix4.prototype.invert;
        }
        if (!THREE.Math) {
          THREE.Math = THREE.MathUtils;
        }
      }
    </script>

    <script>
      const CONFIG = {
          product: {
             // ✅ Now using the real symbol with a custom font
             buttonText: "WeedVerse® Website", 
             link: "https://weedverse.org/shop",
             modelUrl: "https://raw.githubusercontent.com/foti1/wverse/0f07c5e8dfc49840ce972d53d5a3ba5b47a4b780/cwhand.glb",
             scale: "0.1 0.1 0.1" 
          }
      };

      AFRAME.registerComponent('scroll-move', {
        init: function () {
          this.speed = 2.5;
          window.addEventListener('wheel', (e) => {
            const rig = this.el;
            const camera = document.querySelector('[camera]');
            const direction = new THREE.Vector3();
            camera.object3D.getWorldDirection(direction);
            direction.y = 0; 
            direction.normalize();
            const moveStrength = e.deltaY > 0 ? -this.speed : this.speed;
            const currentPos = rig.getAttribute('position');
            rig.removeAttribute('animation');
            rig.setAttribute('animation', {
                property: 'position',
                to: `${currentPos.x + (direction.x * moveStrength)} ${currentPos.y} ${currentPos.z + (direction.z * moveStrength)}`,
                dur: 150,
                easing: 'linear'
            });
          });
        }
      });

      // PAN CONTROLS
      AFRAME.registerComponent('pan-controls', {
        init: function () {
          this.panning = false;
          this.cameraObj = this.el.object3D;
          this.panSpeed = 0.01; 

          window.addEventListener('mousedown', (e) => {
            if (e.button === 2) { 
                this.panning = true;
            }
          });

          window.addEventListener('mouseup', () => {
            this.panning = false;
          });

          window.addEventListener('mousemove', (e) => {
            if (!this.panning) return;
            this.cameraObj.translateX(-e.movementX * this.panSpeed);
            this.cameraObj.translateY(e.movementY * this.panSpeed);
          });
        }
      });

      document.addEventListener('contextmenu', event => event.preventDefault());

      window.onload = function() {
          document.querySelector('#product-entity').setAttribute('gltf-model', CONFIG.product.modelUrl);
          
          const openProductLink = () => {
              window.open(CONFIG.product.link, '_blank');
          };

          const textFields = document.querySelectorAll('.dynamic-text');
          textFields.forEach(text => {
              text.setAttribute('value', CONFIG.product.buttonText);
          });

          const bgPlate = document.querySelector('#btn-bg');
          const estimatedWidth = (CONFIG.product.buttonText.length * 0.05) + 0.3; 
          bgPlate.setAttribute('geometry', { primitive: 'plane', height: 0.3, width: estimatedWidth });
          
          bgPlate.addEventListener('click', openProductLink);
          document.querySelector('#product-entity').addEventListener('click', openProductLink);
      };
    </script>
  </head>

  <body>
    <a-scene> 
      <a-assets>
        <img id="sky-texture" src="https://cdn.aframe.io/360-image-gallery-boilerplate/img/sechelt.jpg" crossorigin="anonymous">
      </a-assets>

      <a-sky src="#sky-texture" rotation="0 -90 0"></a-sky>
      <a-plane id="floor" class="walkable" position="0 0 -4" rotation="-90 0 0" width="100" height="100" color="#222" material="src: https://cdn.aframe.io/a-painter/images/floor.jpg; repeat: 50 50"></a-plane>
      
      <a-text 
        value="WeedVerse®" 
        font="https://cdn.jsdelivr.net/gh/etiennepinchon/aframe-fonts/fonts/exo2/Exo2-Bold.json"
        position="0 0.02 -1.5" 
        rotation="-90 0 0" 
        align="center" 
        color="#00ff00"
        scale="3 3 3">
      </a-text>
      
      <a-light type="ambient" color="#ffffff" intensity="1.2"></a-light>
      <a-light type="directional" position="-1 1 0" intensity="1.0"></a-light>
      <a-light type="point" position="0 2 -2" intensity="2.0" distance="10" color="#ffffff"></a-light>

      <a-entity 
        id="product-entity"
        class="clickable" 
        position="0 1.0 -3" 
        scale="0.1 0.1 0.1" 
        rotation="0 45 0"
        animation="property: rotation; to: 0 405 0; loop: true; dur: 10000; easing: linear">
          
          <a-entity position="0 4.5 0">
              <a-entity id="btn-bg"
                        class="clickable"
                        material="color: black; opacity: 0.9; side: double">
              </a-entity>
              <a-text class="dynamic-text" font="https://cdn.jsdelivr.net/gh/etiennepinchon/aframe-fonts/fonts/exo2/Exo2-Bold.json" value="LOADING..." align="center" position="0 0 0.01" color="white" width="4" side="double"></a-text>
              <a-text class="dynamic-text" font="https://cdn.jsdelivr.net/gh/etiennepinchon/aframe-fonts/fonts/exo2/Exo2-Bold.json" value="LOADING..." align="center" position="0 0 -0.01" rotation="0 180 0" color="white" width="4" side="double"></a-text>
          </a-entity>
      </a-entity>

      <a-entity id="player-rig"
                scroll-move
                position="0 0 4"
                wasd-controls="acceleration: 20">
        
        <a-entity 
            id="head" 
            camera 
            position="0 1.6 0" 
            look-controls="pointerLockEnabled: false"
            pan-controls>
            <a-entity cursor="fuse: false; rayOrigin: mouse;"
                      raycaster="objects: .clickable">
            </a-entity>
        </a-entity>
      </a-entity>

    </a-scene>
  </body>
</html>


