<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>WeedVerseÂ® POC</title>
    
    <script src="https://aframe.io/releases/1.6.0/aframe.min.js"></script>

    <style>
        /* CRITICAL: Prevents the whole page from scrolling when you drag on mobile */
        html, body { overflow: hidden; position: fixed; width: 100%; height: 100%; }
        canvas { touch-action: none; }
    </style>

    <script>
      if (typeof THREE !== 'undefined') {
        if (!THREE.Quaternion.prototype.inverse) THREE.Quaternion.prototype.inverse = THREE.Quaternion.prototype.invert;
        if (!THREE.Matrix4.prototype.inverse) THREE.Matrix4.prototype.inverse = THREE.Matrix4.prototype.invert;
        if (!THREE.Math) THREE.Math = THREE.MathUtils;
      }
    </script>

    <script>
      const CONFIG = {
          product: {
             buttonText: "WeedVerse Website", 
             link: "https://weedverse.org/shop",
             modelUrl: "https://raw.githubusercontent.com/foti1/wverse/0f07c5e8dfc49840ce972d53d5a3ba5b47a4b780/cwhand.glb",
             scale: "0.1 0.1 0.1" 
          }
      };

      // ==================================================
      // COMPONENT: UNIVERSAL CONTROLS (Mobile + Desktop)
      // ==================================================
      AFRAME.registerComponent('universal-controls', {
        init: function () {
          this.camera = this.el.object3D;
          
          // Settings
          this.touchSensitivity = 0.008; 
          this.scrollSensitivity = 0.5;
          this.mousePanSensitivity = 0.01;

          // State
          this.isRightClicking = false;
          this.touchStart = { x: 0, y: 0 };
          
          // --- EVENT LISTENERS ---
          this.bindMethods();
          this.addEventListeners();
        },

        bindMethods: function () {
          this.onWheel = this.onWheel.bind(this);
          this.onMouseDown = this.onMouseDown.bind(this);
          this.onMouseUp = this.onMouseUp.bind(this);
          this.onMouseMove = this.onMouseMove.bind(this);
          this.onTouchStart = this.onTouchStart.bind(this);
          this.onTouchMove = this.onTouchMove.bind(this);
        },

        addEventListeners: function () {
          const canvas = this.el.sceneEl.canvas;
          
          // Desktop
          window.addEventListener('wheel', this.onWheel);
          window.addEventListener('mousedown', this.onMouseDown);
          window.addEventListener('mouseup', this.onMouseUp);
          window.addEventListener('mousemove', this.onMouseMove);

          // Mobile (Passive: false is required to prevent scrolling)
          canvas.addEventListener('touchstart', this.onTouchStart, {passive: false});
          canvas.addEventListener('touchmove', this.onTouchMove, {passive: false});
        },

        // --- DESKTOP LOGIC ---
        onWheel: function (e) {
            // Scroll Up = Move Forward (-Z), Down = Move Back (+Z)
            const delta = e.deltaY > 0 ? 1 : -1;
            this.moveCameraZ(delta * this.scrollSensitivity);
        },

        onMouseDown: function (e) {
            if (e.button === 2) this.isRightClicking = true;
        },

        onMouseUp: function () {
            this.isRightClicking = false;
        },

        onMouseMove: function (e) {
            if (!this.isRightClicking) return;
            // Right Click Drag: Pan X/Y
            this.moveCameraX(-e.movementX * this.mousePanSensitivity);
            this.moveCameraY(e.movementY * this.mousePanSensitivity);
        },

        // --- MOBILE LOGIC ---
        onTouchStart: function (e) {
            if (e.touches.length === 2) {
                this.touchStart.x = (e.touches[0].clientX + e.touches[1].clientX) / 2;
                this.touchStart.y = (e.touches[0].clientY + e.touches[1].clientY) / 2;
            }
        },

        onTouchMove: function (e) {
            // We only care about 2-finger drag
            if (e.touches.length !== 2) return;
            
            // Prevent Browser Scroll
            e.preventDefault(); 

            // Calculate current midpoint
            const currentX = (e.touches[0].clientX + e.touches[1].clientX) / 2;
            const currentY = (e.touches[0].clientY + e.touches[1].clientY) / 2;

            const deltaX = currentX - this.touchStart.x;
            const deltaY = currentY - this.touchStart.y;

            // 2-Finger Horizontal = Pan Left/Right
            this.moveCameraX(-deltaX * this.touchSensitivity);

            // 2-Finger Vertical = Move Forward/Back (Zoom)
            this.moveCameraZ(-deltaY * this.touchSensitivity * 3); // *3 to make zooming faster

            // Reset start for next frame
            this.touchStart.x = currentX;
            this.touchStart.y = currentY;
        },

        // --- HELPER MOVEMENT FUNCTIONS ---
        // Moves camera relative to where it is looking
        moveCameraZ: function (distance) {
            const direction = new THREE.Vector3();
            this.camera.getWorldDirection(direction);
            direction.y = 0; // Keep movement flat
            direction.normalize();
            this.camera.position.addScaledVector(direction, -distance); // Invert distance for natural feel
        },

        moveCameraX: function (distance) {
            this.camera.translateX(distance);
        },

        moveCameraY: function (distance) {
            this.camera.translateY(distance);
        }
      });

      // ==================================================
      // INIT SCENE
      // ==================================================
      document.addEventListener('contextmenu', event => event.preventDefault());

      window.onload = function() {
          // Set Model
          document.querySelector('#product-entity').setAttribute('gltf-model', CONFIG.product.modelUrl);
          
          // Link Logic
          const openProductLink = () => { window.open(CONFIG.product.link, '_blank'); };

          // Update UI Text
          const textFields = document.querySelectorAll('.dynamic-text');
          textFields.forEach(text => { text.setAttribute('value', CONFIG.product.buttonText); });

          // Resize Button
          const bgPlate = document.querySelector('#btn-bg');
          const estimatedWidth = (CONFIG.product.buttonText.length * 0.05) + 0.3; 
          bgPlate.setAttribute('geometry', { primitive: 'plane', height: 0.3, width: estimatedWidth });
          
          // Add Click Listeners
          bgPlate.addEventListener('click', openProductLink);
          document.querySelector('#product-entity').addEventListener('click', openProductLink);
      };
    </script>
  </head>

  <body>
    <a-scene> 
      <a-assets>
        <img id="sky-texture" src="https://cdn.aframe.io/360-image-gallery-boilerplate/img/sechelt.jpg" crossorigin="anonymous">
      </a-assets>

      <a-sky src="#sky-texture" rotation="0 -90 0"></a-sky>
      <a-plane id="floor" class="walkable" position="0 0 -4" rotation="-90 0 0" width="100" height="100" color="#222" material="src: https://cdn.aframe.io/a-painter/images/floor.jpg; repeat: 50 50"></a-plane>
      
      <a-text 
        value="WeedVerse" 
        font="exo2bold"
        position="0 0.02 -1.5" 
        rotation="-90 0 0" 
        align="center" 
        color="#00ff00"
        scale="3 3 3">
      </a-text>
      
      <a-light type="ambient" color="#ffffff" intensity="1.2"></a-light>
      <a-light type="directional" position="-1 1 0" intensity="1.0"></a-light>
      <a-light type="point" position="0 2 -2" intensity="2.0" distance="10" color="#ffffff"></a-light>

      <a-entity 
        id="product-entity"
        class="clickable" 
        position="0 1.0 -3" 
        scale="0.1 0.1 0.1" 
        rotation="0 45 0"
        animation="property: rotation; to: 0 405 0; loop: true; dur: 10000; easing: linear">
          
          <a-entity position="0 4.5 0">
              <a-entity id="btn-bg"
                        class="clickable"
                        material="color: black; opacity: 0.9; side: double">
              </a-entity>
              <a-text class="dynamic-text" font="exo2bold" value="LOADING..." align="center" position="0 0 0.01" color="white" width="4" side="double"></a-text>
              <a-text class="dynamic-text" font="exo2bold" value="LOADING..." align="center" position="0 0 -0.01" rotation="0 180 0" color="white" width="4" side="double"></a-text>
          </a-entity>
      </a-entity>

      <a-entity id="player-rig"
                universal-controls
                position="0 0 4">
        
        <a-entity 
            id="head" 
            camera 
            position="0 1.6 0" 
            look-controls="pointerLockEnabled: false">
            
            <a-entity cursor="fuse: false; rayOrigin: mouse;"
                      raycaster="objects: .clickable">
            </a-entity>
        </a-entity>
      </a-entity>

    </a-scene>
  </body>
</html>
